<!DOCTYPE html>
<html lang="ru">
<head>
<title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR-–∫–æ–¥–æ–≤ | GIBDD Hub</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- Libraries -->
<script type="text/javascript" src="qrcode.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
	/* Theme Panel Removed - Fixed Dark Theme */
	:root {
		/* Fixed: Cyber Dark */
		--bg-deep: #0f172a;
		--bg-card: #1e293b;
		--primary: #3b82f6;
		--primary-hover: #2563eb;
		--accent: #f59e0b;
		--text-main: #f8fafc;
		--text-muted: #94a3b8;
		--border: #334155;
		--success: #10b981;
		--warning: #f59e0b;
		--danger: #ef4444;
		--primary-rgb: 59, 130, 246;
	}

	* { box-sizing: border-box; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }

	body {
		font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
		margin: 0;
		padding: 20px 10px;
		background: var(--bg-deep);
		color: var(--text-main);
		line-height: 1.5;
		min-height: 100vh;
		display: flex;
		flex-direction: column;
		align-items: center;
	}

	.container {
		width: 100%;
		max-width: 850px;
		background: var(--bg-card);
		border: 1px solid var(--border);
		border-radius: 24px;
		padding: 30px;
		box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
		position: relative;
	}

	header { text-align: center; margin-bottom: 30px; }
	
	/* Theme Panel Styles Removed */

	h1 { 
		font-size: 28px; 
		margin: 0 0 8px; 
		background: linear-gradient(135deg, var(--primary), var(--accent));
		background-clip: text;
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		font-weight: 800; 
		letter-spacing: -0.03em;
	}
	.subtitle { font-size: 14px; color: var(--text-muted); margin: 0; }

	/* Input Section */
	.input-group {
		margin-bottom: 30px;
		position: relative;
	}
	
	.step-number {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 24px; height: 24px;
		background: var(--bg-deep);
		border: 1px solid var(--border);
		border-radius: 50%;
		font-size: 10px;
		color: var(--text-muted);
		margin-right: 8px;
		font-weight: 700;
	}

	.input-wrapper {
		position: relative;
		display: flex;
		align-items: center;
	}

	#text {
		width: 100%;
		padding: 18px 50px 18px 50px;
		font-size: 16px;
		background: var(--bg-deep);
		border: 2px solid var(--border);
		border-radius: 16px;
		color: var(--text-main);
		outline: none;
		box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
		transition: all 0.3s;
	}

	#text:focus {
		border-color: var(--primary);
		box-shadow: 0 0 0 4px rgba(var(--primary-rgb), 0.15);
		background: var(--bg-card);
	}

	.status-icon-wrap {
		position: absolute;
		left: 18px;
		display: flex;
		align-items: center;
		pointer-events: none;
		color: var(--text-muted);
	}

	.validator-icon { font-size: 18px; opacity: 0; transition: 0.3s; transform: scale(0.5); position: absolute; }
	.validator-icon.active { opacity: 1; transform: scale(1); color: var(--success); }
	
	.icon-default { font-size: 18px; transition: 0.3s; opacity: 1; }

	.char-counter {
		position: absolute;
		right: 18px;
		font-size: 11px;
		color: var(--text-muted);
		pointer-events: none;
		background: var(--bg-card);
		padding: 2px 8px;
		border-radius: 6px;
		border: 1px solid var(--border);
	}

	.btn-primary {
		background: var(--primary);
		color: white;
		border: none;
		padding: 12px 24px;
		border-radius: 12px;
		font-weight: 700;
		cursor: pointer;
		transition: all 0.2s;
		display: flex;
		align-items: center;
		gap: 8px;
		margin-top: 15px;
	}
	.btn-primary:hover {
		background: var(--primary-hover);
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3);
	}
	.btn-primary:active { transform: translateY(0); }

	.dynamic-tip {
		font-size: 12px;
		margin-top: 8px;
		color: var(--primary);
		min-height: 18px;
		padding-left: 10px;
		opacity: 0.8;
	}

	/* Config Grid */
	.config-grid {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 30px;
		margin-bottom: 30px;
	}

	.section-title {
		font-size: 10px;
		text-transform: uppercase;
		letter-spacing: 1.5px;
		color: var(--text-muted);
		margin-bottom: 15px;
		font-weight: 700;
		display: flex;
		align-items: center;
		gap: 0;
	}
	.section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); opacity: 0.5; margin-left: 10px; }

	.toggle-row {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: 12px 14px;
		margin-bottom: 10px;
		background: var(--bg-deep);
		border: 1px solid var(--border);
		border-radius: 12px;
		cursor: pointer;
		transition: all 0.2s;
	}
	.toggle-row:hover { border-color: var(--primary); transform: translateX(2px); }

	.toggle-label { display: flex; flex-direction: column; }
	.t-title { font-size: 14px; font-weight: 600; color: var(--text-main); }
	.t-desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

	.toggle-switch {
		position: relative;
		width: 44px;
		height: 24px;
		background: var(--border);
		border-radius: 20px;
		transition: 0.3s;
		flex-shrink: 0;
	}
	.toggle-switch::after {
		content: '';
		position: absolute;
		top: 3px; left: 3px;
		width: 18px; height: 18px;
		background: white;
		border-radius: 50%;
		transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		box-shadow: 0 1px 3px rgba(0,0,0,0.2);
	}
	input:checked + .toggle-switch { background: var(--success); }
	input:checked + .toggle-switch::after { transform: translateX(20px); }
	input[type="checkbox"] { display: none; }

	.segmented-control {
		display: flex;
		background: var(--bg-deep);
		border: 1px solid var(--border);
		border-radius: 14px;
		padding: 4px;
		width: 100%;
	}
	.segmented-control button {
		flex: 1;
		padding: 8px;
		font-size: 12px;
		border-radius: 10px;
		background: transparent;
		color: var(--text-muted);
		font-weight: 700;
		border: none;
		cursor: pointer;
		transition: all 0.2s;
	}
	.segmented-control button.active {
		background: var(--bg-card);
		color: var(--primary);
		box-shadow: 0 2px 8px rgba(0,0,0,0.15);
	}

	.result-area {
		display: flex;
		flex-direction: column;
		padding: 30px;
		background: var(--bg-card); /* Matching 1,2,3 - wait, 1,2,3 use bg-card for the main container and deep for inputs? No, the container is bg-card */
		border-radius: 24px;
		position: relative;
		border: 1px solid var(--border);
		transition: all 0.3s;
		overflow: hidden;
		margin-top: 30px;
	}

	.qr-preview-url {
		font-family: 'Cascadia Code', 'Courier New', monospace;
		font-size: 11px;
		color: var(--primary);
		background: var(--bg-deep);
		padding: 8px 12px;
		border-radius: 10px;
		border: 1px solid var(--border);
		margin-bottom: 20px;
		word-break: break-all;
		display: none;
		align-items: center;
		gap: 8px;
	}
	.qr-preview-url::before { content: 'üîó'; font-size: 12px; }

	.qr-text-label {
		margin-top: 10px;
		font-size: 12px;
		font-weight: 600;
		color: var(--text-main);
		text-align: center;
		display: none;
	}
	
	.result-step-header {
		font-size: 10px;
		text-transform: uppercase;
		letter-spacing: 1.5px;
		color: var(--text-muted);
		font-weight: 700;
		display: flex;
		align-items: center;
		width: 100%;
		margin-bottom: 25px;
	}
	.result-step-header::after { content: ''; flex: 1; height: 1px; background: var(--border); opacity: 0.5; margin-left: 10px; }

	.result-area.drag-over { border-color: var(--accent); transform: scale(1.01); }

	/* QR Main Layout */
	.qr-main-layout {
		display: grid;
		grid-template-columns: 100px auto 116px;
		align-items: center;
		gap: 14px;
		width: 100%;
		max-width: 760px;
		margin-bottom: 20px;
	}

	.qr-style-picker {
		display: flex;
		gap: 10px;
		flex-direction: column;
		flex-wrap: nowrap;
		justify-content: center;
		align-items: center;
	}

	.qr-left-controls {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 10px;
		min-width: 0;
		background: var(--bg-card);
		padding: 10px 8px;
		border-radius: 14px;
		border: 1px solid var(--border);
	}

	.style-dot {
		width: 24px;
		height: 24px;
		border-radius: 50%;
		cursor: pointer;
		border: 1px solid var(--border);
		transition: transform 0.2s;
		position: relative;
	}
	.style-dot:hover { transform: scale(1.2); }
	.style-dot.active { transform: scale(1.2); box-shadow: 0 0 0 2px var(--bg-deep), 0 0 0 4px var(--primary); }
	
	.bg-toggle-compact {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 24px; height: 24px;
		border-radius: 6px;
		background: var(--bg-deep);
		border: 1px solid var(--border);
		cursor: pointer;
		color: var(--text-muted);
		transition: 0.2s;
	}
	.bg-toggle-compact input { display: none; }
	.bg-toggle-compact:hover { border-color: var(--primary); color: var(--primary); }
	.bg-toggle-compact input:checked + div { color: var(--success); }
	.bg-toggle-compact.active-toggle { background: var(--primary); border-color: var(--primary); color: white !important; }

	.mode-item {
		display: flex;
		align-items: center;
		gap: 6px;
		width: 100%;
		cursor: pointer;
	}
	.mode-text {
		font-size: 9px;
		font-weight: 700;
		color: var(--text-muted);
		letter-spacing: 0.5px;
	}
	.active-toggle + .mode-text { color: var(--primary); }

	/* Transparency Effect on Buttons */
	.btn-highlight { 
		border-color: var(--accent) !important; 
		color: var(--accent) !important; 
		box-shadow: 0 0 10px rgba(245, 158, 11, 0.2); 
	}
	.complexity-info {
		margin-top: 15px;
		font-size: 11px;
		color: var(--text-muted);
		background: rgba(59, 130, 246, 0.1);
		padding: 8px 12px;
		border-radius: 8px;
		border: 1px solid rgba(59, 130, 246, 0.2);
		text-align: center;
		max-width: 320px;
	}

	#qrcode {
		margin-bottom: 15px;
		border-radius: 6px; /* Sharper corners for QR */
		overflow: hidden;
		transition: opacity 0.5s;
		border: 12px solid white; /* More whitespace */
		background: white;
		box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
	}
	#qrcode img, #qrcode svg { display: block; }
	
	.stress-mode #qrcode { filter: blur(3px) contrast(1.5) grayscale(1); }
	.stress-label {
		position: absolute;
		top: 15px; right: 15px;
		background: var(--danger);
		color: white;
		font-size: 10px; font-weight: 800;
		padding: 4px 8px;
		border-radius: 6px;
		display: none;
	}
	.stress-mode .stress-label { display: block; }

	.action-row {
		display: grid;
		grid-template-columns: 1fr;
		gap: 8px;
		width: 116px;
		background: var(--bg-card);
		padding: 8px;
		border-radius: 14px;
		border: 1px solid var(--border);
	}

	.btn-dl {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 10px 4px;
		background: var(--bg-card);
		border: 1px solid var(--border);
		border-radius: 10px;
		color: var(--text-main);
		font-size: 10px;
		font-weight: 700;
		cursor: pointer;
		transition: all 0.2s;
	}
	.btn-dl span { margin-bottom: 4px; font-size: 16px; }
	.btn-dl:hover {
		background: var(--primary);
		color: white;
		border-color: var(--primary);
		transform: translateY(-4px);
		box-shadow: 0 10px 20px -5px rgba(var(--primary-rgb), 0.4);
	}

	/* Footer Info */
	.info-footer {
		margin-top: 40px;
		padding-top: 30px;
		border-top: 1px solid var(--border);
		width: 100%;
	}
	.info-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
		gap: 15px;
	}
	.info-item {
		background: var(--bg-deep);
		padding: 15px;
		border-radius: 14px;
		border: 1px solid var(--border);
	}
	.info-item h3 { font-size: 13px; margin: 0 0 6px; color: var(--primary); }
	.info-item p { font-size: 11px; color: var(--text-muted); margin: 0; line-height: 1.4; }

	.lang-switcher {
		position: absolute;
		top: 30px;
		right: 30px;
		display: flex;
		align-items: center;
		gap: 8px;
		font-size: 12px;
		font-weight: 700;
		background: var(--bg-deep);
		padding: 6px 10px;
		border-radius: 20px;
		border: 1px solid var(--border);
		cursor: pointer;
	}
	.lang-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); transition: all 0.3s; }
	.lang-active-rus .lang-dot { background: var(--success); transform: translateX(0); }
	.lang-active-eng .lang-dot { background: var(--primary); transform: translateX(24px); }
	.lang-active-rus span:first-of-type { color: var(--text-main); }
	.lang-active-eng span:last-of-type { color: var(--text-main); }
	.lang-switcher span { color: var(--text-muted); transition: 0.3s; }

	.hidden { display: none !important; }
	@media (max-width: 650px) {
		.config-grid { grid-template-columns: 1fr; gap: 15px; }
		.container { padding: 20px; border-radius: 0; border: none; }
		.qr-main-layout { grid-template-columns: 1fr; }
		.qr-left-controls, .action-row { width: 100%; }
		.action-row { grid-template-columns: repeat(2, 1fr); }
		.qr-style-picker { flex-direction: row; flex-wrap: wrap; }
		/* .theme-panel removed */
		.lang-switcher { top: 15px; right: 15px; }
	}
</style>
</head>
<body>

<main class="container">
	<!-- Theme Panel Removed -->

	<div class="lang-switcher lang-active-rus" id="lang-toggle">
		<span class="lang-label">RU</span>
		<div class="lang-dot"></div>
		<span class="lang-label">EN</span>
	</div>

	<header>
		<h1 data-i18n="title">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR-–∫–æ–¥–æ–≤</h1>
		<p class="subtitle" data-i18n="subtitle">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ—á–Ω—ã—Ö QR-–∫–æ–¥–æ–≤</p>
	</header>

	<div class="input-group">
		<div class="section-title">
			<span class="step-number">01</span>
			<span data-i18n="step1">–¶–ï–õ–ï–í–ê–Ø –°–°–´–õ–ö–ê</span>
		</div>
		<div class="input-wrapper">
			<div class="status-icon-wrap">
				<span class="validator-icon" id="validator-icon">‚úì</span>
				<span class="icon-default" id="default-icon">üåê</span>
			</div>
			<input type="text" id="text" data-i18n-placeholder="placeholder" placeholder="yoursite.ru" autocomplete="off" spellcheck="false">
			<div class="char-counter" id="char-counter">0</div>
		</div>
		<button id="btn-generate" class="btn-primary hidden">
			<span data-i18n="btn-gen">–°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥</span>
			<span>üöÄ</span>
		</button>
		<div class="dynamic-tip" id="dynamic-tip" data-i18n="tip-wait">–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —Å–∞–π—Ç–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã...</div>
	</div>

	<div class="config-grid">
		<div class="col-left">
			<div class="section-title">
				<span class="step-number">02</span>
				<span data-i18n="step2">–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø</span>
			</div>
			
			<label class="toggle-row">
				<div class="toggle-label">
					<span class="t-title" data-i18n="opt-utm">–û—á–∏—Å—Ç–∫–∞ UTM</span>
					<span class="t-desc" data-i18n="opt-utm-desc">–£–¥–∞–ª—è–µ—Ç —Ä–µ–∫–ª–∞–º–Ω—ã–µ –º–µ—Ç–∫–∏</span>
				</div>
				<input type="checkbox" id="strip-tracking" checked>
				<div class="toggle-switch"></div>
			</label>

			<label class="toggle-row">
				<div class="toggle-label">
					<span class="t-title" data-i18n="opt-https">–ü—Ä–æ—Ç–æ–∫–æ–ª HTTPS</span>
					<span class="t-desc" data-i18n="opt-https-desc">–ê–≤—Ç–æ-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫</span>
				</div>
				<input type="checkbox" id="add-protocol" checked>
				<div class="toggle-switch"></div>
			</label>
		</div>

		<div class="col-right">
			<div class="section-title">
				<span class="step-number">03</span>
				<span data-i18n="step3">–ù–ê–°–¢–†–û–ô–ö–ò</span>
			</div>

			<div style="margin-bottom: 20px;">
				<div class="segmented-control" id="complexity-selector">
					<button data-level="L">L</button>
					<button data-level="M">M</button>
					<button data-level="Q">Q</button>
					<button data-level="H" class="active">H</button>
				</div>
				<div style="font-size: 10px; color: var(--text-muted); margin-top: 6px; text-align: center;" id="complexity-desc">
					<span data-i18n="complex-info">–£—Ä–æ–≤–µ–Ω—å H (30%)</span>
				</div>
			</div>
		</div>
	</div>

	<div class="result-area hidden">
		<div class="section-title">
			<span class="step-number">04</span>
			<span data-i18n="step4">–í–ò–ó–£–ê–õ –ò –≠–ö–°–ü–û–†–¢</span>
		</div>

		<div id="url-preview" class="qr-preview-url"></div>

		<div class="stress-label">SCAN SIMULATION MODE</div>
		
		<div class="qr-main-layout">
			<div class="qr-left-controls">
				<div style="font-size: 8px; color: var(--text-muted); font-weight: 800; letter-spacing: 1px; margin-bottom: 4px;" data-i18n="label-colors">–¶–í–ï–¢–ê</div>
				<div class="qr-style-picker">
					<div class="style-dot active" style="background: linear-gradient(135deg, white 50%, black 50%);" data-fg="#000000" data-bg="#ffffff" data-i18n-title="Classic Mono"></div>
					<div class="style-dot" style="background: linear-gradient(135deg, #1e293b 50%, #facc15 50%);" data-fg="#facc15" data-bg="#1e293b" data-i18n-title="Cyber Yellow (Dark)"></div>
					<div class="style-dot" style="background: linear-gradient(135deg, #f0fdf4 50%, #15803d 50%);" data-fg="#15803d" data-bg="#f0fdf4" data-i18n-title="Eco Green"></div>
					<div class="style-dot" style="background: linear-gradient(135deg, #eff6ff 50%, #1d4ed8 50%);" data-fg="#1d4ed8" data-bg="#eff6ff" data-i18n-title="Tech Blue"></div>
					<div class="style-dot" style="background: linear-gradient(135deg, #fff1f2 50%, #be123c 50%);" data-fg="#be123c" data-bg="#fff1f2" data-i18n-title="Brand Red"></div>
				</div>
				<div style="font-size: 8px; color: var(--text-muted); font-weight: 800; letter-spacing: 1px; margin: 10px 0 4px;" data-i18n="label-modes">–†–ï–ñ–ò–ú–´</div>
				<div style="display:flex; flex-direction:column; gap:8px; width: 100%;">
					<label class="mode-item" data-i18n-title="opt-trans">
						<div class="bg-toggle-compact">
							<input type="checkbox" id="toggle-transparency">
							<div class="bg-check" style="font-size:10px;">‚¨õ</div>
						</div>
						<span class="mode-text" data-i18n="label-trans">–ü–†–û–ó–†–ê–ß.</span>
					</label>
					<label class="mode-item" data-i18n-title="stress-desc">
						<div class="bg-toggle-compact">
							<input type="checkbox" id="toggle-stress">
							<div class="bg-check" style="font-size:10px;">‚ö†Ô∏è</div>
						</div>
						<span class="mode-text" data-i18n="label-stress">–¢–ï–°–¢</span>
					</label>
				</div>
			</div>

			<div style="display: flex; flex-direction: column; align-items: center;">
				<div id="qrcode"></div>
			</div>

			<div class="action-row">
				<button class="btn-dl" id="download-png" title="Raster image, great for web/social"><span>üñºÔ∏è</span> PNG</button>
				<button class="btn-dl" id="download-jpg" title="Common image format, white background"><span>üì∏</span> JPG</button>
				<button class="btn-dl" id="download-svg" title="Vector graphics, infinite scaling for print"><span>‚úèÔ∏è</span> SVG</button>
				<button class="btn-dl" id="download-pdf" title="Document format for sharing/printing"><span>üìÑ</span> PDF</button>
			</div>
		</div>

		<!-- Visual Status Tips -->
		<div id="visual-status-tip" style="margin-top: 5px; margin-bottom: 10px; font-size: 11px; color: var(--accent); min-height: 16px; text-align: center; font-weight: 600; opacity: 0; transition: opacity 0.3s;"></div>
	</div>

	<footer class="info-footer">
		<div class="info-grid">
			<div class="info-item">
				<h3 data-i18n="f1-t">–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å</h3>
				<p data-i18n="f1-p">–ü—Ä—è–º–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤. –ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ—á–Ω–æ, –ø–æ–∫–∞ –∂–∏–≤ –≤–∞—à –¥–æ–º–µ–Ω.</p>
			</div>
			<div class="info-item">
				<h3 data-i18n="f2-title">–§–æ—Ä–º–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∞</h3>
				<p style="margin-bottom: 8px;"><strong style="color:var(--primary);">PNG/JPG:</strong> <span data-i18n="exp-raster">–î–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π –∏ –±—ã—Å—Ç—Ä–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏.</span></p>
				<p><strong style="color:var(--primary);">SVG/PDF:</strong> <span data-i18n="exp-vector">–í–µ–∫—Ç–æ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∏, –±–∏–ª–±–æ—Ä–¥–æ–≤ –∏ –ø–µ—á–∞—Ç–∏ –ª—é–±–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.</span></p>
			</div>
			<div class="info-item">
				<h3 data-i18n="f3-t">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</h3>
				<p data-i18n="f4-p">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –î–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä.</p>
			</div>
		</div>
		<div style="text-align: center; margin-top: 30px; font-size: 10px; color: var(--text-muted); opacity: 0.5;">
			ENGINEERED BY <a href="https://github.com/Hedgenious" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none; border-bottom: 1px solid var(--border);">HEDGENIOUS</a>
		</div>
	</footer>

	<!-- Hidden hosts -->
	<div id="svg-host" style="display:none;"></div>
	<div id="raster-host" style="display:none;"></div>
</main>

<script type="text/javascript">
(function () {
	// --- Elements ---
	var els = {
		input: document.getElementById("text"),
		counter: document.getElementById("char-counter"),
		tip: document.getElementById("dynamic-tip"),
		visualTip: document.getElementById("visual-status-tip"),
		validator: document.getElementById("validator-icon"),
		defaultIcon: document.getElementById("default-icon"),
		btnGenerate: document.getElementById("btn-generate"),
		resultArea: document.querySelector(".result-area"),
		urlPreview: document.getElementById("url-preview"),
		qrcode: document.getElementById("qrcode"),
		svgHost: document.getElementById("svg-host"),
		rasterHost: document.getElementById("raster-host"),
		
		// Toggles
		stripTracking: document.getElementById("strip-tracking"),
		addProtocol: document.getElementById("add-protocol"),
		transparency: document.getElementById("toggle-transparency"),
		stress: document.getElementById("toggle-stress"),
		
		// Controls
		complexBtns: document.querySelectorAll("#complexity-selector button"),
		complexDesc: document.getElementById("complexity-desc"),
		// Theme Dots removed
		colorDots: document.querySelectorAll(".style-dot"),
		// customColor removed
		langToggle: document.getElementById("lang-toggle"),
		
		// Badges
		// badgeEcc: document.getElementById("complexity-badge"), // Removed
		complexInfoTxt: document.querySelector("[data-i18n='complex-info']"),
		
		// DL
		dlPng: document.getElementById("download-png"),
		dlJpg: document.getElementById("download-jpg"),
		dlSvg: document.getElementById("download-svg"),
		dlPdf: document.getElementById("download-pdf")
	};

	// --- State ---
	var state = {
		text: "",
		level: "H",
		fg: "#000000",
		bg: "#ffffff",
		isTransparent: false,
		lang: "RU"
	};

	var translations = {
		RU: {
			title: "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR-–∫–æ–¥–æ–≤",
			subtitle: "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ—á–Ω—ã—Ö QR-–∫–æ–¥–æ–≤",
			step1: "–¶–ï–õ–ï–í–ê–Ø –°–°–´–õ–ö–ê",
			placeholder: "yoursite.ru",
			tip_wait: "–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —Å–∞–π—Ç–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã...",
			tip_ok: "‚ú® –û—Ç–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞. –ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é.",
			tip_long: "üí° –í —Å—Å—ã–ª–∫–µ –º–Ω–æ–≥–æ UTM-–º–µ—Ç–æ–∫. –ö–æ–¥ –±—É–¥–µ—Ç —Å–ª–æ–∂–Ω—ã–º –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.",
			tip_space: "‚ö†Ô∏è –í —Å—Å—ã–ª–∫–µ –µ—Å—Ç—å –ø—Ä–æ–±–µ–ª—ã ‚Äî –æ–Ω–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.",
			tip_invalid_chars: "‚õî –í —Å—Å—ã–ª–∫–µ –µ—Å—Ç—å –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã: < > \" ` \\ | ^ [ ]",
			tip_missing_domain: "‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ, –≤ —Å—Å—ã–ª–∫–µ –Ω–µ—Ç –¥–æ–º–µ–Ω–∞ (–ø—Ä–∏–º–µ—Ä: site.ru).",
			tip_http: "‚ÑπÔ∏è –ë—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω https://",
			step2: "–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø",
			opt_utm: "–û—á–∏—Å—Ç–∫–∞ UTM",
			opt_utm_desc: "–£–¥–∞–ª—è–µ—Ç —Ä–µ–∫–ª–∞–º–Ω—ã–µ –º–µ—Ç–∫–∏",
			opt_https: "–ü—Ä–æ—Ç–æ–∫–æ–ª HTTPS",
			opt_https_desc: "–ê–≤—Ç–æ-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫",
			step3: "–ù–ê–°–¢–†–û–ô–ö–ò",
			opt_trans: "–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω",
			opt_trans_desc: "–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –¥–∏–∑–∞–π–Ω–∞",
			stress_desc: "–°–∏–º—É–ª—è—Ü–∏—è –ø–ª–æ—Ö–∏—Ö —É—Å–ª–æ–≤–∏–π",
			f1_t: "–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å",
			f1_p: "–ü—Ä—è–º–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤. –ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ—á–Ω–æ.",
			f2_t: "SVG –í–µ–∫—Ç–æ—Ä",
			f2_p: "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∏.",
			f4_t: "–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å",
			f4_p: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ü—Ä–∏–≤–∞—Ç–Ω–æ.",
			complex_h: "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å (30%)",
			exp_raster: "–î–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π –∏ –±—ã—Å—Ç—Ä–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏.",
			exp_vector: "–í–µ–∫—Ç–æ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∏, –±–∏–ª–±–æ—Ä–¥–æ–≤ –∏ –ø–µ—á–∞—Ç–∏ –ª—é–±–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.",
			complex_info: "–£—Ä–æ–≤–µ–Ω—å –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –æ—à–∏–±–æ–∫ (H) 30% ‚Äî QR —á–∏—Ç–∞–µ—Ç—Å—è –¥–∞–∂–µ –ø—Ä–∏ 30% –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π.",
			opt_trans_short: "–í–∫–ª. –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å",
			tip_trans_on: "üí° –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞: SVG –∏ PDF —Å–æ—Ö—Ä–∞–Ω—è—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –¥–∏–∑–∞–π–Ω–∞.",
			tip_stress_on: "üß™ –†–µ–∂–∏–º –∑–∞–º–µ—Ä–∞: –∏–º–∏—Ç–∞—Ü–∏—è –ø–ª–æ—Ö–æ–≥–æ –æ—Å–≤–µ—â–µ–Ω–∏—è –∏ —Ä–∞–∑–º—ã—Ç–∏—è –∫–∞–º–µ—Ä—ã.",
			step4: "–í–ò–ó–£–ê–õ –ò –≠–ö–°–ü–û–†–¢",
			label_colors: "–¶–í–ï–¢–ê",
			label_modes: "–†–ï–ñ–ò–ú–´",
			label_trans: "–ü–†–û–ó–†–ê–ß.",
			label_stress: "–¢–ï–°–¢",
			f2_title: "–§–æ—Ä–º–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∞",
			btn_gen: "–°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥",
			tip_manual: "üí° –°—Å—ã–ª–∫–∞ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–∞—è. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–¥–∞.",
			tip_filename: "‚ÑπÔ∏è –°—Å—ã–ª–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞."
		},
		EN: {
			title: "QR Code Generator",
			subtitle: "Professional tool for eternal QR links",
			step1: "TARGET URL",
			placeholder: "yoursite.com",
			tip_wait: "Enter URL to start generating...",
			tip_ok: "‚ú® Perfect link. QR Code is ready.",
			tip_long: "üí° Too many tracking tags. QR might be harder to scan.",
			tip_space: "‚ö†Ô∏è URL contains spaces ‚Äî they will be removed automatically.",
			tip_invalid_chars: "‚õî URL contains invalid characters: < > \" ` \\ | ^ [ ]",
			tip_missing_domain: "‚ö†Ô∏è URL seems to have no domain (example: site.com).",
			tip_http: "‚ÑπÔ∏è https:// will be added automatically",
			step2: "OPTIMIZATION",
			opt_utm: "Clean UTM",
			opt_utm_desc: "Removes tracking tags",
			opt_https: "Enforce HTTPS",
			opt_https_desc: "Auto-fix protocol",
			step3: "SETTINGS",
			opt_trans: "Transparent BG",
			opt_trans_desc: "Best for design overlays",
			stress_desc: "Simulate print damage",
			f1_t: "Reliability",
			f1_p: "Direct coding. No redirects. Works forever.",
			f2_t: "Vector SVG",
			f2_p: "Professional print format. Infinite scaling.",
			f4_t: "Privacy",
			f4_p: "Client-side generation. 100% Private.",
			complex_h: "Max Reliability (30%)",
			exp_raster: "Best for social media, screens, and quick sharing.",
			exp_vector: "Vector format. Perfect for print, billboards, and scaling.",
			complex_info: "Error Correction Level (H) 30% ‚Äî QR remains readable with 30% damage.",
			opt_trans_short: "Transparency",
			tip_trans_on: "üí° Transparency active: SVG/PDF will have no background for design overlays.",
			tip_stress_on: "üß™ Test Mode: simulating low light and motion blur for reliability.",
			opt_label: "Label under QR",
			opt_label_desc: "Add human-readable URL",
			step4: "VISUAL & EXPORT",
			label_colors: "COLORS",
			label_modes: "MODES",
			label_trans: "TRANS.",
			label_stress: "TEST",
			f2_title: "Export Formats",
			btn_gen: "Generate QR Code",
			tip_manual: "üí° Link is very long. Press the button below to generate.",
			tip_filename: "‚ÑπÔ∏è The URL is automatically included in the filename for convenience."
		}
	};

	// --- Init ---
	function init() {
		setupListeners();
		// Set default URL if empty
		if(!els.input.value) {
			els.input.value = "https://hedgenious.github.io/QR_code_generator/";
			handleInput();
		}
		updateLang();
	}

	function setupListeners() {
		// Auto-generate on any input
		els.input.addEventListener("input", handleInput);
		els.btnGenerate.addEventListener("click", function() {
			generate();
			els.resultArea.classList.remove("hidden");
			els.btnGenerate.classList.add("hidden");
		});
		
		// Config Toggles
		[els.stripTracking, els.addProtocol, els.transparency, els.stress].forEach(function(el) {
			el.addEventListener("change", generate);
		});

		// Complexity
		els.complexBtns.forEach(function(btn) {
			btn.addEventListener("click", function() {
				els.complexBtns.forEach(function(b) { b.classList.remove("active"); });
				btn.classList.add("active");
				state.level = btn.getAttribute("data-level");
				generate();
			});
		});

		// Theme Dot logic removed

		// QR Color
		els.colorDots.forEach(function(dot) {
			dot.addEventListener("click", function() {
				els.colorDots.forEach(function(d) { d.classList.remove("active"); });
				dot.classList.add("active");
				state.fg = dot.getAttribute("data-fg");
				state.bg = dot.getAttribute("data-bg");
				
				// Optional: Update QR code bg color visually in container
				if(state.bg !== "#ffffff") {
					els.qrcode.style.backgroundColor = state.bg;
					els.qrcode.style.borderColor = state.bg;
				} else {
					els.qrcode.style.backgroundColor = "white";
					els.qrcode.style.borderColor = "white";
				}
				
				generate();
			});
		});

		// els.customColor removed

		// Lang
		els.langToggle.addEventListener("click", function() {
			state.lang = state.lang === "RU" ? "EN" : "RU";
			els.langToggle.className = "lang-switcher lang-active-" + state.lang.toLowerCase();
			updateLang();
		});

		// Downloads
		els.dlPng.addEventListener("click", downloadPng);
		els.dlJpg.addEventListener("click", downloadJpg);
		els.dlSvg.addEventListener("click", downloadSvg);
		els.dlPdf.addEventListener("click", downloadPdf);
	}

	function handleInput() {
		var val = els.input.value;
		els.counter.textContent = val.length;
		var dict = translations[state.lang];
		
		if (val.length > 0) {
			els.validator.classList.add("active");
			els.defaultIcon.style.opacity = "0";

			// Auto-generate logic
			if (val.length <= 100) {
				els.resultArea.classList.remove("hidden");
				els.btnGenerate.classList.add("hidden");
				generate();
			} else {
				// Too long for auto: show button if not already visible/rendered
				els.tip.textContent = dict.tip_manual;
				els.tip.style.color = "var(--primary)";
				els.btnGenerate.classList.remove("hidden");
				// Note: we don't call generate() yet
			}
		} else {
			els.validator.classList.remove("active");
			els.defaultIcon.style.opacity = "1";
			els.resultArea.classList.add("hidden");
			els.btnGenerate.classList.add("hidden");
			els.tip.textContent = dict.tip_wait;
			els.tip.style.color = "var(--primary)";
		}
	}

	function getInputTip(rawInput, normalizedUrl) {
		var dict = translations[state.lang];
		if (!rawInput) {
			return { text: dict.tip_wait, color: "var(--primary)" };
		}

		if (/\s/.test(rawInput)) {
			return { text: dict.tip_space, color: "var(--warning)" };
		}

		if (/[<>"`\\|^\[\]]/.test(rawInput)) {
			return { text: dict.tip_invalid_chars, color: "var(--danger)" };
		}

		if (!/[a-zA-Z0-9-]+\.[a-zA-Z]{2,}/.test(rawInput)) {
			return { text: dict.tip_missing_domain, color: "var(--warning)" };
		}

		if (els.addProtocol.checked && !/^https?:\/\//i.test(rawInput)) {
			return { text: dict.tip_http, color: "var(--primary)" };
		}

		// Only suggest shortening if UTM/Tracking tags are actually present
		if (normalizedUrl.length > 70 && /[?&](utm_|fbclid|gclid)/i.test(rawInput)) {
			return { text: dict.tip_long, color: "var(--warning)" };
		}

		return { text: dict.tip_ok, color: "var(--success)" };
	}

	function normalizeUrl(url) {
		if (!url) return "";
		url = url.trim().replace(/\s+/g, "");
		
		// Add Protocol
		if (els.addProtocol.checked && !/^https?:\/\//i.test(url)) {
			url = "https://" + url;
		}

		try {
			var urlObj = new URL(url);
			
			// Strip Tracking
			if (els.stripTracking.checked) {
				var params = urlObj.searchParams;
				["utm_source", "utm_medium", "utm_campaign", "utm_term", "utm_content", "fbclid", "gclid"].forEach(function(p) {
					params.delete(p);
				});
			}

			// return urlObj.toString(); // Full URL
			// For robustness, sometimes we might want to return urlObj.href
			return urlObj.href;
		} catch (e) {
			return url;
		}
	}

	function generate() {
		var raw = els.input.value;
		if (!raw) return;

		var finalUrl = normalizeUrl(raw);
		state.isTransparent = els.transparency.checked;
		
		// Highlight Logic
		if(state.isTransparent) {
			els.dlSvg.classList.add("btn-highlight");
			els.dlPdf.classList.add("btn-highlight");
			// Visual cue on toggle
			els.transparency.parentElement.classList.add("active-toggle");
		} else {
			els.dlSvg.classList.remove("btn-highlight");
			els.dlPdf.classList.remove("btn-highlight");
			els.transparency.parentElement.classList.remove("active-toggle");
		}

		if(els.stress.checked) {
			els.stress.parentElement.classList.add("active-toggle");
		} else {
			els.stress.parentElement.classList.remove("active-toggle");
		}

		// URL Preview Update
		if (finalUrl) {
			els.urlPreview.textContent = finalUrl;
			els.urlPreview.style.display = "flex";
		} else {
			els.urlPreview.style.display = "none";
		}

		// Canvas Generation (Display)
		els.qrcode.innerHTML = "";
		// Even if transparent, we draw white on canvas for visibility
		// But in JS, we can use bg color from state if provided
		var displayBg = state.bg || "#ffffff";
		var displayFg = state.fg; 

		// Override for display if transparent is checked - still need visible background in UI?
		// User said: "default black and white, enable transparency... vector format highlighted"
		// If transparent, we might want to show a checkerboard in UI? 
		// For now, let's keep it clean white in UI but apply transparency to export.
		// Or better: Apply the chosen BG color.
		
		// If custom pair selected, use it.
		
		new QRCode(els.qrcode, {
			text: finalUrl,
			width: 256,
			height: 256,
			colorDark: displayFg,
			colorLight: displayBg,
			correctLevel: QRCode.CorrectLevel[state.level]
		});

		// Background SVG Generation (For Export)
		els.svgHost.innerHTML = "";
		// Logic for transparency export:
		// If Transparent is checked, use "transparent" colorLight.
		// Else use selected BG.
		var exportBg = state.isTransparent ? "rgba(0,0,0,0)" : displayBg;

		new QRCode(els.svgHost, {
			text: finalUrl,
			width: 1024,
			height: 1024,
			colorDark: displayFg,
			colorLight: exportBg,
			correctLevel: QRCode.CorrectLevel[state.level],
			useSVG: true
		});

		// Hidden Raster Generation (For PNG/JPG export reliability)
		els.rasterHost.innerHTML = "";
		new QRCode(els.rasterHost, {
			text: finalUrl,
			width: 1024,
			height: 1024,
			colorDark: displayFg,
			colorLight: exportBg,
			correctLevel: QRCode.CorrectLevel[state.level]
		});
		
		// Styling updates
		if (els.stress.checked) {
			document.body.classList.add("stress-mode");
		} else {
			document.body.classList.remove("stress-mode");
		}

		// Update Tip
		var tip = getInputTip(raw, finalUrl);
		els.tip.textContent = tip.text;
		els.tip.style.color = tip.color;
		
		// Update complexity info text based on level
		var infoMap = {
			L: (state.lang === "RU" ? "–ù–∏–∑–∫–∞—è (7%) ‚Äî –•–æ—Ä–æ—à–æ –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤." : "Low (7%) ‚Äî Good for screens."),
			M: (state.lang === "RU" ? "–°—Ä–µ–¥–Ω—è—è (15%) ‚Äî –°—Ç–∞–Ω–¥–∞—Ä—Ç." : "Medium (15%) ‚Äî Standard."),
			Q: (state.lang === "RU" ? "–í—ã—Å–æ–∫–∞—è (25%) ‚Äî –î–ª—è –ø–µ—á–∞—Ç–∏." : "Quality (25%) ‚Äî For print."),
			H: (state.lang === "RU" ? "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è (30%) ‚Äî QR —á–∏—Ç–∞–µ—Ç—Å—è –¥–∞–∂–µ –ø—Ä–∏ 30% –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π." : "Max (30%) ‚Äî QR remains readable with 30% damage.")
		};
		if(els.complexInfoTxt) els.complexInfoTxt.textContent = infoMap[state.level];

		// Update Visual Tip
		var dict = translations[state.lang];
		if(els.stress.checked) {
			els.visualTip.textContent = dict.tip_stress_on;
			els.visualTip.style.opacity = "1";
		} else if(state.isTransparent) {
			els.visualTip.textContent = dict.tip_trans_on;
			els.visualTip.style.opacity = "1";
		} else if (raw.length > 0) {
			els.visualTip.textContent = dict.tip_filename;
			els.visualTip.style.opacity = "0.7";
		} else {
			els.visualTip.style.opacity = "0";
		}
	}

	function updateLang() {
		var dict = translations[state.lang];
		
		// Static text updates
		document.querySelectorAll("[data-i18n]").forEach(function(el) {
			var k = el.getAttribute("data-i18n");
			// Map keys like "opt-utm" to "opt_utm"
			var cleanK = k.replace(/-/g, "_"); 
			if (dict[cleanK]) el.textContent = dict[cleanK];
			if (dict[k]) el.textContent = dict[k]; 
		});

		document.querySelectorAll("[data-i18n-placeholder]").forEach(function(el) {
			el.placeholder = dict.placeholder;
		});

		document.querySelectorAll("[data-i18n-title]").forEach(function(el) {
			var k = el.getAttribute("data-i18n-title");
			var cleanK = k.replace(/-/g, "_");
			if (dict[cleanK]) el.title = dict[cleanK];
			if (dict[k]) el.title = dict[k];
		});

		if (els.input.value) handleInput();
		else els.tip.textContent = dict.tip_wait;
	}

	// --- Export Logic ---
	function buildSafeFileName(extension) {
		var raw = els.input.value || "";
		var normalized = normalizeUrl(raw);
		if (!normalized) {
			return "qr-code." + extension;
		}

		var withoutProtocol = normalized.replace(/^https?:\/\//i, "");

		var sanitize = function (value) {
			return String(value || "")
				.replace(/[<>:"/\\|?*\x00-\x1F]/g, "")
				.replace(/\s+/g, "-")
				.replace(/[^a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å._-]/g, "")
				.replace(/-+/g, "-")
				.replace(/^[-_.]+|[-_.]+$/g, "");
		};

		var safeLink = sanitize(withoutProtocol);
		if (!safeLink) {
			safeLink = "qr";
		}

		var nameCore = safeLink;
		if (safeLink.length > 20) {
			nameCore = safeLink.slice(0, 10) + "-" + safeLink.slice(-10);
		}

		return "qr-" + nameCore + "." + extension;
	}

	function buildExportCanvas(size, forceOpaqueForJpg) {
		var raw = els.input.value;
		if (!raw) return null;

		try {
			var finalUrl = normalizeUrl(raw);
			var exportCanvas = document.createElement("canvas");
			exportCanvas.width = size;
			exportCanvas.height = size;
			var ctx = exportCanvas.getContext("2d");

			var bg = state.bg || "#ffffff";
			if (forceOpaqueForJpg || !state.isTransparent) {
				ctx.fillStyle = bg;
				ctx.fillRect(0, 0, size, size);
			} else {
				ctx.clearRect(0, 0, size, size);
			}

			var qr = new QRCode(document.createElement("div"), {
				text: finalUrl,
				width: size,
				height: size,
				colorDark: state.fg,
				colorLight: "#ffffff",
				correctLevel: QRCode.CorrectLevel[state.level]
			});

			var model = qr && qr._oQRCode ? qr._oQRCode : null;
			if (!model || typeof model.getModuleCount !== "function" || typeof model.isDark !== "function") {
				return null;
			}

			var modules = model.getModuleCount();
			var quietZone = 4;
			var total = modules + quietZone * 2;
			var cell = size / total;

			ctx.fillStyle = state.fg || "#000000";
			for (var row = 0; row < modules; row++) {
				for (var col = 0; col < modules; col++) {
					if (!model.isDark(row, col)) continue;
					var x1 = Math.round((col + quietZone) * cell);
					var y1 = Math.round((row + quietZone) * cell);
					var x2 = Math.round((col + quietZone + 1) * cell);
					var y2 = Math.round((row + quietZone + 1) * cell);
					ctx.fillRect(x1, y1, Math.max(1, x2 - x1), Math.max(1, y2 - y1));
				}
			}

			return exportCanvas;
		} catch (e) {
			var visibleCanvas = els.qrcode.querySelector("canvas");
			if (visibleCanvas) {
				var fallbackOut = document.createElement("canvas");
				fallbackOut.width = visibleCanvas.width;
				fallbackOut.height = visibleCanvas.height;
				var fallbackCtx = fallbackOut.getContext("2d");
				if (forceOpaqueForJpg || !state.isTransparent) {
					fallbackCtx.fillStyle = state.bg || "#ffffff";
					fallbackCtx.fillRect(0, 0, fallbackOut.width, fallbackOut.height);
				}
				fallbackCtx.drawImage(visibleCanvas, 0, 0);
				return fallbackOut;
			}
			return null;
		}
	}

	function saveCanvas(canvas, mimeType, fileName, quality) {
		if (!canvas) return;
		var dataUrl = canvas.toDataURL(mimeType, quality);
		triggerDownload(dataUrl, fileName);
	}

	function downloadPng() {
		var canvas = buildExportCanvas(1024, false);
		if (!canvas) {
			alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å PNG. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
			return;
		}
		saveCanvas(canvas, "image/png", buildSafeFileName("png"));
	}

	function downloadJpg() {
		var canvas = buildExportCanvas(1024, true);
		if (!canvas) {
			alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å JPG. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
			return;
		}
		saveCanvas(canvas, "image/jpeg", buildSafeFileName("jpg"), 0.92);
	}

	function downloadSvg() {
		var svg = els.svgHost.querySelector("svg");
		if (!svg) return;
		
		var serializer = new XMLSerializer();
		
		// If custom background, we should probably insert a rect if it's not transparent
		// But qrcode.js with useSVG:true usually creates a rect for bg if colorLight is set.
		// However, my updated generate() logic sets colorLight to 'transparent' if toggle on,
		// or state.bg otherwise.
		
		var source = serializer.serializeToString(svg);
		
		// Ensure XML declaration
		if (!source.match(/^<\?xml/)) {
			source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
		}

		// Download SVG
		var url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
		triggerDownload(url, buildSafeFileName("svg"));
	}

	function downloadPdf() {
		var { jsPDF } = window.jspdf;
		var doc = new jsPDF('p', 'mm', 'a4');
		
		// Create a high-res virtual page (A4-ish aspect ratio)
		var width = 1200;
		var height = 1600;
		var canv = document.createElement("canvas");
		canv.width = width;
		canv.height = height;
		var ctx = canv.getContext("2d");
		
		// 1. Background
		ctx.fillStyle = "#ffffff";
		ctx.fillRect(0, 0, width, height);
		
		// 2. Title (Safe Cyrillic via Canvas)
		ctx.fillStyle = "#000000";
		// Using standard system fonts that support RU
		ctx.font = "bold 64px 'Segoe UI', Arial, sans-serif";
		ctx.textAlign = "center";
		var title = translations[state.lang].title;
		ctx.fillText(title, width/2, 180);
		
		// 3. URL
		ctx.font = "32px 'Segoe UI', monospace";
		ctx.fillStyle = "#3b82f6";
		var displayUrl = normalizeUrl(els.input.value);
		if(displayUrl.length > 55) displayUrl = displayUrl.substring(0, 52) + "...";
		ctx.fillText(displayUrl, width/2, 260);
		
		// 4. QR Code
		var qrCvs = buildExportCanvas(1024, true);
		if(qrCvs) {
			// Center the 1024x1024 QR code
			ctx.drawImage(qrCvs, (width - 850)/2, 350, 850, 850);
		}
		
		// 5. Footer
		ctx.fillStyle = "#94a3b8";
		ctx.font = "28px 'Segoe UI', sans-serif";
		ctx.fillText("ENGINEERED BY HEDGENIOUS", width/2, 1450);
		
		var imgData = canv.toDataURL("image/jpeg", 0.95);

		// Add page-filling image to PDF (210mm width for A4)
		doc.addImage(imgData, 'JPEG', 0, 0, 210, 280);
		
		doc.save(buildSafeFileName("pdf"));
	}

	function triggerDownload(url, name) {
		var a = document.createElement("a");
		a.href = url;
		a.download = name;
		a.rel = "noopener";
		a.style.display = "none";
		document.body.appendChild(a);

		try {
			if (typeof a.download === "undefined") {
				window.open(url, "_blank");
			} else {
				a.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
			}
		} catch (e) {
			window.open(url, "_blank");
		}

		setTimeout(function() {
			if (a.parentNode) {
				a.parentNode.removeChild(a);
			}
		}, 200);
	}

	// Start
	init();

})();
</script>
</body>
</html>